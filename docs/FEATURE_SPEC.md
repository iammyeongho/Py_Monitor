# Py_Monitor 기능 명세서

> 버전: 1.0.0
> 최종 업데이트: 2026-02-05

---

## 1. 시스템 개요

Py_Monitor는 웹사이트 가용성, SSL 인증서, 도메인 만료일을 모니터링하고 알림을 제공하는 통합 모니터링 플랫폼입니다.

### 1.1 기술 스택

| 계층 | 기술 |
|------|------|
| 백엔드 프레임워크 | FastAPI 0.104+ |
| ORM | SQLAlchemy 2.0+ |
| 데이터베이스 | PostgreSQL 15+ |
| 데이터 검증 | Pydantic v2 |
| 인증 | JWT (python-jose) |
| 비동기 HTTP | aiohttp |
| 브라우저 모니터링 | Playwright |
| 캐싱 | Redis |
| 실시간 통신 | WebSocket |

### 1.2 아키텍처

```
[Frontend (HTML/JS/CSS)]
        │
        ├── REST API (/api/v1/*)
        ├── WebSocket (/ws/{user_id})
        │
[FastAPI Application]
        │
        ├── Endpoints (Presentation Layer)
        ├── Services (Business Logic Layer)
        ├── Repositories (Data Access Layer)
        │
[PostgreSQL + Redis]
```

---

## 2. 사용자 관리

### 2.1 인증 시스템

| 기능 | 설명 |
|------|------|
| 회원가입 | 이메일 + 비밀번호(최소 8자) + 이름 |
| 로그인 | OAuth2 password flow, JWT 토큰 발급 |
| 토큰 | Bearer 토큰, 설정된 만료 시간 적용 |
| 마지막 로그인 | 로그인 시 `last_login_at` 자동 기록 |

### 2.2 역할 기반 접근 제어 (RBAC)

| 역할 | 권한 |
|------|------|
| `admin` | 전체 시스템 관리, 사용자 관리, 역할 변경 |
| `manager` | 프로젝트 생성/수정/삭제, 모니터링 전체 |
| `user` | 프로젝트 생성/수정, 모니터링 조회 |
| `viewer` | 읽기 전용 (프로젝트 생성/수정 불가) |

### 2.3 사용자 설정

| 설정 | 옵션 | 기본값 |
|------|------|--------|
| 테마 | `light`, `dark`, `system` | `light` |
| 언어 | `ko`, `en` | `ko` |
| 시간대 | IANA timezone | `Asia/Seoul` |
| 이메일 알림 | `true` / `false` | `true` |

### 2.4 프로필 관리

- 이름, 프로필 이미지, 전화번호 수정
- 비밀번호 변경 (현재 비밀번호 확인 필수)
- 관리자의 사용자 역할 변경 (자기 자신 역할 변경 불가)

---

## 3. 프로젝트 관리

### 3.1 프로젝트 CRUD

프로젝트는 모니터링 대상 웹사이트 단위입니다.

| 필드 | 설명 | 필수 |
|------|------|------|
| `title` | 프로젝트 이름 | O |
| `url` | 모니터링 URL | O |
| `host_name` | 호스트명 | X |
| `ip_address` | IP 주소 | X |
| `description` | 설명 | X |
| `status_interval` | 상태 체크 주기 (초) | X (기본 300) |
| `time_limit` | 응답 시간 제한 (ms) | X |
| `is_public` | 공개 상태 페이지 노출 여부 | X (기본 false) |
| `category` | 카테고리 분류 | X |
| `tags` | 태그 (콤마 구분) | X |
| `custom_headers` | 커스텀 HTTP 헤더 (JSON) | X |

### 3.2 소프트 삭제

프로젝트 삭제 시 `is_active = false`로 설정 (데이터 보존).

### 3.3 유지보수 모드

| 필드 | 설명 |
|------|------|
| `maintenance_mode` | 유지보수 모드 활성화 |
| `maintenance_message` | 유지보수 안내 메시지 |
| `maintenance_ends_at` | 유지보수 종료 예정 시각 |

유지보수 모드 중에는 모니터링 알림이 억제됩니다.

### 3.4 스크린샷

- Playwright를 이용한 프로젝트 페이지 스크린샷 캡처
- 썸네일 자동 생성
- 캐시 적용 (`force=true`로 강제 갱신)

---

## 4. 모니터링 기능

### 4.1 HTTP 상태 모니터링

| 항목 | 설명 |
|------|------|
| 대상 | 등록된 프로젝트 URL |
| 체크 항목 | HTTP 상태 코드, 응답 시간, 가용성 |
| 결과 | `is_available`, `status_code`, `response_time`, `error_message` |
| 주기 | 프로젝트별 `check_interval` 설정 (60~3600초) |

### 4.2 Playwright 심층 모니터링

실제 브라우저(Chromium)를 사용한 깊은 수준의 모니터링.

| 메트릭 | 설명 | 단위 |
|--------|------|------|
| `dom_content_loaded` | DOM 로드 완료 시간 | ms |
| `page_load_time` | 전체 페이지 로드 시간 | ms |
| `first_contentful_paint` | FCP (첫 콘텐츠 렌더링) | ms |
| `largest_contentful_paint` | LCP (최대 콘텐츠 렌더링) | ms |
| `time_to_first_byte` | TTFB (첫 바이트 수신) | ms |
| `cumulative_layout_shift` | CLS (레이아웃 변경 지표) | - |
| `total_blocking_time` | TBT (메인 스레드 차단 시간) | ms |
| `console_errors` | 콘솔 에러 개수 | 건 |
| `js_errors` | JavaScript 에러 목록 | JSON |
| `resource_count` | 로드된 리소스 개수 | 건 |
| `resource_size` | 총 리소스 크기 | bytes |
| `failed_resources` | 실패한 리소스 개수 | 건 |
| `redirect_count` | 리다이렉트 횟수 | 회 |
| `js_heap_size` | JS 힙 메모리 사용량 | bytes |
| `is_dom_ready` | DOM 정상 로드 여부 | bool |
| `is_js_healthy` | JS 에러 없음 여부 | bool |

### 4.3 SSL 인증서 모니터링

| 항목 | 설명 |
|------|------|
| 유효성 | 인증서 유효 여부 |
| 발급자 | 인증서 발급 기관 |
| 만료일 | 인증서 만료 일시 |
| 잔여일 | 만료까지 남은 일수 |
| 알림 | 만료 N일 전 경고 알림 |

### 4.4 도메인 만료 모니터링

| 항목 | 설명 |
|------|------|
| 확인 방법 | WHOIS 조회 |
| 만료일 | 도메인 등록 만료 일시 |
| 알림 | 만료 N일 전 경고 알림 |

### 4.5 TCP 포트 체크

| 항목 | 설명 |
|------|------|
| 입력 | 호스트, 포트(1~65535), 타임아웃(1~30초) |
| 결과 | 포트 열림 여부, 응답 시간, 에러 메시지 |

### 4.6 UDP 포트 체크

| 항목 | 설명 |
|------|------|
| 입력 | 호스트, 포트(1~65535), 타임아웃(1~30초) |
| 결과 | 포트 열림 여부, 필터링 여부 |
| 참고 | UDP 특성상 응답 없음 = `open|filtered` |

### 4.7 DNS 조회

| 항목 | 설명 |
|------|------|
| 입력 | 도메인, 레코드 타입 |
| 지원 타입 | `A`, `AAAA`, `CNAME`, `MX`, `NS`, `TXT`, `SOA` |
| 결과 | 레코드 목록, TTL, 해석 성공 여부 |

### 4.8 콘텐츠 검증

| 항목 | 설명 |
|------|------|
| 입력 | URL, 기대 콘텐츠 문자열, 타임아웃 |
| 결과 | 콘텐츠 포함 여부, 응답 시간, HTTP 상태 코드 |

### 4.9 보안 헤더 체크

다음 HTTP 보안 헤더를 검사하고 0~100점 보안 점수를 산출합니다:

| 헤더 | 설명 |
|------|------|
| `Strict-Transport-Security` | HSTS 설정 |
| `Content-Security-Policy` | CSP 설정 |
| `X-Content-Type-Options` | MIME 스니핑 방지 |
| `X-Frame-Options` | 클릭재킹 방지 |
| `X-XSS-Protection` | XSS 필터 |
| `Referrer-Policy` | 리퍼러 정책 |
| `Permissions-Policy` | 권한 정책 |

### 4.10 API 엔드포인트 체크

| 항목 | 설명 |
|------|------|
| 입력 | URL, HTTP 메서드, 헤더, 바디, 타임아웃 |
| 검증 | 기대 상태 코드, JSON 경로 값 검증 |
| 결과 | 상태 코드, 응답 시간, 응답 본문(1000자), 검증 통과 여부 |

### 4.11 Synthetic 모니터링 (시나리오 테스트)

Playwright 기반 사용자 행동 시나리오 테스트.

**지원 액션:**

| 액션 | 설명 | 필요 파라미터 |
|------|------|---------------|
| `navigate` | URL로 이동 | `value` = URL |
| `click` | 요소 클릭 | `selector` |
| `type` | 텍스트 입력 | `selector`, `value` |
| `select` | 드롭다운 선택 | `selector`, `value` |
| `wait` | 대기 | `value` = ms |
| `screenshot` | 스크린샷 저장 | - |
| `assert_text` | 텍스트 확인 | `selector`, `value` |
| `assert_element` | 요소 존재 확인 | `selector` |
| `assert_url` | URL 확인 | `value` |

**설정:**

| 설정 | 범위 | 기본값 |
|------|------|--------|
| `timeout` | 5,000~120,000ms | 30,000ms |
| `viewport_width` | 320~1920px | 1280px |
| `viewport_height` | 480~1080px | 800px |

### 4.12 콘텐츠 변경 감지

| 항목 | 설명 |
|------|------|
| 원리 | 페이지 콘텐츠의 SHA-256 해시 비교 |
| 설정 | `content_change_detection` 활성화 |
| 셀렉터 | `content_selector`로 특정 영역만 감시 (null이면 전체) |
| 결과 | 해시 변경 시 알림 발송 |

### 4.13 키워드 모니터링

| 항목 | 설명 |
|------|------|
| 설정 | `keyword_monitoring` 활성화 |
| 키워드 | `keywords` (JSON 배열 문자열) |
| 모드 | `keyword_alert_on_found=true`: 키워드 발견 시 알림 |
|  | `keyword_alert_on_found=false`: 키워드 미발견 시 알림 |

---

## 5. 모니터링 설정

프로젝트별 모니터링 동작을 세부 설정합니다.

| 설정 | 범위 | 기본값 | 설명 |
|------|------|--------|------|
| `check_interval` | 60~3600초 | 300초 | 체크 주기 |
| `timeout` | 5~300초 | 30초 | 요청 타임아웃 |
| `retry_count` | 1~5회 | 3회 | 실패 시 재시도 |
| `alert_threshold` | 1~10회 | 3회 | 연속 실패 N회 시 알림 |
| `is_alert_enabled` | bool | true | 알림 활성화 |
| `alert_email` | string | null | 알림 수신 이메일 |
| `webhook_url` | string | null | 웹훅 알림 URL |

---

## 6. 스케줄러

백그라운드에서 자동 모니터링을 수행하는 스케줄러입니다.

### 6.1 동작 방식

```
[스케줄러 시작]
    │
    ├── 프로젝트별 태스크 생성 (0.5초 간격 시차 시작)
    │
    ├── 각 프로젝트 루프:
    │   ├── HTTP 모니터링 (매 사이클)
    │   ├── Playwright 모니터링 (6사이클마다 1회)
    │   ├── 콘텐츠 변경 감지
    │   ├── 키워드 모니터링
    │   ├── 연속 실패 추적 → 임계값 초과 시 알림
    │   └── 복구 감지 → 복구 알림
    │
    ├── SSL/도메인 만료 체크 (시작 5분 후, 이후 매일)
    └── 로그 자동 정리 (매일)
```

### 6.2 동시성 제어

| 항목 | 제한 |
|------|------|
| HTTP 동시 요청 | 최대 10개 (`asyncio.Semaphore`) |
| Playwright 동시 실행 | 최대 2개 (`asyncio.Semaphore`) |
| 시차 시작 간격 | 0.5초 |

### 6.3 스케줄러 제어 API

| 기능 | 설명 |
|------|------|
| 전체 시작/중지 | 모든 프로젝트 모니터링 시작/중지 |
| 개별 시작/중지 | 특정 프로젝트만 시작/중지 |
| 즉시 체크 | 대기 없이 즉시 모니터링 실행 |
| 상태 조회 | 실행 중인 프로젝트, 연속 실패 현황 |

---

## 7. 알림 시스템

### 7.1 알림 종류

| 유형 | 트리거 |
|------|--------|
| 장애 알림 | 연속 실패 횟수가 `alert_threshold` 초과 |
| 복구 알림 | 장애 후 정상 복구 |
| SSL 만료 경고 | SSL 인증서 만료 N일 전 |
| 도메인 만료 경고 | 도메인 만료 N일 전 |
| 콘텐츠 변경 | 모니터링 대상 콘텐츠 해시 변경 |
| 키워드 감지 | 설정된 키워드 발견/미발견 |

### 7.2 알림 채널

| 채널 | 설명 |
|------|------|
| 이메일 | SMTP를 통한 이메일 알림 |
| 웹훅 | HTTP POST로 외부 서비스 연동 (Slack, Discord 등) |
| WebSocket | 실시간 브라우저 푸시 |
| 앱 내 알림 | 알림 목록 저장 및 읽음 관리 |

### 7.3 알림 템플릿

| 템플릿 | 용도 |
|--------|------|
| `status_error` | HTTP 상태 오류 알림 |
| `ssl_error` | SSL 인증서 오류 알림 |
| `domain_expiry` | 도메인 만료 예정 알림 |
| `monitoring_error` | 모니터링 시스템 오류 알림 |

### 7.4 알림 관리

- 알림 CRUD (생성/조회/수정/삭제)
- 읽지 않은 알림 조회
- 전체 읽음 처리
- 프로젝트별 알림 조회

---

## 8. 리포트 및 분석

### 8.1 SLA (Uptime) 리포트

| 지표 | 설명 |
|------|------|
| 목표 가용률 | SLA 목표 (기본 99.9%) |
| 달성 가용률 | 실제 가용률 |
| SLA 충족 여부 | 목표 대비 달성 |
| 총 다운타임 | 장애 총 시간 (분) |
| 허용 다운타임 | SLA 기준 허용 다운타임 (분) |
| 인시던트 수 | 장애 발생 횟수 |
| 평균/최대/최소/P95 응답시간 | 응답 시간 통계 |
| 일별 분석 | 일별 가용률 및 응답시간 |
| 인시던트 목록 | 장애 시작/종료/지속시간/에러메시지 |

### 8.2 이상 탐지 (Anomaly Detection)

통계 기반 이상 징후 자동 감지.

| 감지 유형 | 설명 |
|-----------|------|
| `response_time_spike` | 응답 시간 급증 |
| `availability_drop` | 가용성 하락 |
| `error_rate_increase` | 에러율 증가 |
| `pattern_change` | 패턴 변화 |

| 심각도 | 설명 |
|--------|------|
| `info` | 참고 수준 |
| `warning` | 주의 필요 |
| `critical` | 즉시 대응 필요 |

**설정 파라미터:**

| 파라미터 | 기본값 | 설명 |
|----------|--------|------|
| `analysis_hours` | 1시간 | 분석 대상 기간 |
| `baseline_hours` | 168시간 (7일) | 기준선 기간 |
| `sensitivity` | 2.0 | 민감도 (표준편차 배수) |

### 8.3 차트 데이터

| 차트 | 설명 |
|------|------|
| 대시보드 차트 | 전체 프로젝트 응답시간 + 가용성 (기간 설정) |
| 프로젝트 응답시간 | 개별 프로젝트 응답시간 추이 |
| 프로젝트 가용성 | 개별 프로젝트 가용성 추이 |
| 대시보드 통계 | 전체 현황 요약 (30초 캐시) |

### 8.4 리포트 내보내기

| 형식 | 설명 |
|------|------|
| CSV | 모니터링 로그 CSV 다운로드 |
| PDF(HTML) | 인쇄용 HTML 리포트 생성 |

---

## 9. 공개 상태 페이지

인증 없이 접근 가능한 시스템 상태 대시보드입니다.

### 9.1 기능

| 기능 | 설명 |
|------|------|
| 전체 시스템 상태 | `operational` / `degraded` / `major_outage` |
| 프로젝트 상태 목록 | `is_public=true`인 프로젝트만 노출 |
| 가용률 표시 | 24시간, 7일, 30일 가용률 |
| 응답시간 표시 | 현재 응답시간 |
| 상세 페이지 | 90일 업타임 히스토리, 최근 인시던트 |
| 캐시 | 목록 60초, 상세 120초 (Redis) |

### 9.2 접근 경로

- URL: `/frontend/html/status.html`
- API: `/api/v1/status/`

---

## 10. Uptime 뱃지

README나 외부 문서에 삽입 가능한 SVG 뱃지입니다.

| 뱃지 | 경로 | 표시 |
|------|------|------|
| 가용률 | `/api/v1/badge/{id}/uptime?period=30d` | "uptime: 99.9%" |
| 상태 | `/api/v1/badge/{id}/status` | "status: up" / "status: down" |
| 응답시간 | `/api/v1/badge/{id}/response-time` | "response time: 234ms" |

- 인증 불필요
- 5분 캐시 적용
- `is_public=true` 프로젝트만 지원

---

## 11. 실시간 통신 (WebSocket)

### 11.1 연결

```
ws://host/ws/{user_id}
```

### 11.2 메시지 타입

**클라이언트 → 서버:**

| 타입 | 설명 |
|------|------|
| `subscribe` | 프로젝트 업데이트 구독 |
| `unsubscribe` | 구독 해제 |
| `ping` | 연결 유지 |

**서버 → 클라이언트:**

| 타입 | 설명 |
|------|------|
| `status` | 프로젝트 상태 업데이트 (가용성, 응답시간, 상태코드, 성능등급) |
| `alert` | 장애/복구 알림 |
| `pong` | ping 응답 |

---

## 12. 모바일 API

모바일 클라이언트에 최적화된 경량 API입니다.

| 엔드포인트 | 설명 |
|-----------|------|
| `GET /mobile/projects` | 페이지네이션 지원 프로젝트 목록 |
| `GET /mobile/dashboard` | 대시보드 요약 정보 |
| `GET /mobile/alerts` | 미해결 알림 목록 (페이지네이션) |

---

## 13. 데이터 정리

### 13.1 자동 정리

스케줄러가 매일 자동으로 오래된 데이터를 정리합니다.

### 13.2 수동 정리

| 대상 | 기본 보관일 | 설명 |
|------|-----------|------|
| 모니터링 로그 | 30일 | `retention_days >= 0` |
| 모니터링 알림 | 90일 | 해결된 알림만 또는 전체 |
| 전체 정리 | 로그 30일 + 알림 90일 | 일괄 정리 |

### 13.3 통계 조회

- 프로젝트별 로그/알림 건수
- 디스크 사용량 추정

---

## 14. 프론트엔드 페이지

| 페이지 | 파일 | 설명 |
|--------|------|------|
| 대시보드 | `index.html` | 프로젝트 목록, 상태 개요, 차트, 실시간 |
| 로그인 | `login.html` | 사용자 인증 |
| 회원가입 | `register.html` | 새 사용자 등록 |
| 프로젝트 등록 | `project.html` | 프로젝트 추가/수정 |
| 프로필 | `profile.html` | 사용자 설정, 테마, 언어 |
| 상태 페이지 | `status.html` | 공개 시스템 상태 |
| 도구 | `tools.html` | TCP/DNS/Content/보안 헤더 체크 도구 |

---

## 부록: 에러 코드

| HTTP 상태 | 의미 |
|-----------|------|
| 200 | 성공 |
| 400 | 잘못된 요청 (입력 검증 실패) |
| 401 | 인증 실패 |
| 403 | 권한 없음 |
| 404 | 리소스 없음 |
| 409 | 충돌 (중복 데이터) |
| 429 | 요청 횟수 초과 (Rate Limit) |
| 500 | 서버 내부 오류 |
