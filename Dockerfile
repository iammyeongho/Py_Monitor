# =============================================================================
# PyMonitor Dockerfile
# =============================================================================
# Docker 이미지 빌드 설정 파일
#
# Laravel 개발자를 위한 설명:
# - Dockerfile = Laravel Sail의 docker/Dockerfile과 유사
# - 각 명령어(FROM, RUN, COPY 등)는 레이어를 생성
# - 레이어는 캐싱되어 빌드 속도 향상
# =============================================================================

# -----------------------------------------------------------------------------
# Stage 1: 베이스 이미지 설정
# -----------------------------------------------------------------------------
# python:3.11-slim = Debian 기반 경량 Python 이미지 (~150MB)
# - slim: 불필요한 패키지 제거된 버전 (alpine보다 호환성 좋음)
# - 전체 이미지: ~1GB, slim: ~150MB, alpine: ~50MB
FROM python:3.11-slim

# -----------------------------------------------------------------------------
# 환경 변수 설정
# -----------------------------------------------------------------------------
# PYTHONDONTWRITEBYTECODE: .pyc 파일 생성 방지 (컨테이너에서 불필요)
# PYTHONUNBUFFERED: 출력 버퍼링 비활성화 (로그 즉시 출력)
# TZ: 타임존 설정 (로그 시간, 스케줄러 등에 영향)
# LANG/LC_ALL: 로케일 설정 (한글 처리 지원)
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    TZ=Asia/Seoul \
    LANG=ko_KR.UTF-8 \
    LC_ALL=ko_KR.UTF-8

# -----------------------------------------------------------------------------
# 작업 디렉토리 설정
# -----------------------------------------------------------------------------
# 이후 모든 명령어는 /app 디렉토리에서 실행
WORKDIR /app

# -----------------------------------------------------------------------------
# 시스템 패키지 설치
# -----------------------------------------------------------------------------
# apt-get update: 패키지 목록 갱신
# apt-get install -y: 자동 확인(yes)으로 설치
#   - gcc: Python 패키지 컴파일용 (psycopg2 등)
#   - postgresql-client: DB 연결 테스트용 (pg_isready)
#   - curl: 헬스체크용 HTTP 클라이언트
#   - locales: 한글 로케일 지원
# rm -rf /var/lib/apt/lists/*: apt 캐시 삭제 (이미지 크기 감소)
#
# 로케일 생성:
#   - sed: /etc/locale.gen에서 ko_KR.UTF-8 주석 해제
#   - locale-gen: 로케일 파일 생성
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    postgresql-client \
    curl \
    locales \
    && rm -rf /var/lib/apt/lists/* \
    && sed -i '/ko_KR.UTF-8/s/^# //g' /etc/locale.gen \
    && locale-gen

# -----------------------------------------------------------------------------
# 비root 사용자 생성 (보안)
# -----------------------------------------------------------------------------
# 컨테이너가 해킹당해도 root 권한 획득 방지
# useradd -m: 홈 디렉토리 생성 (-m = --create-home)
# chown: /app 디렉토리 소유권을 appuser에게 부여
RUN useradd -m appuser \
    && chown -R appuser:appuser /app

# -----------------------------------------------------------------------------
# Python 의존성 설치
# -----------------------------------------------------------------------------
# requirements.txt만 먼저 복사하는 이유:
# - Docker 레이어 캐싱 활용
# - 코드 변경 시에도 pip install 레이어 재사용
# - 빌드 시간 단축 (의존성 변경 없으면 캐시 사용)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# -----------------------------------------------------------------------------
# 애플리케이션 코드 복사
# -----------------------------------------------------------------------------
# COPY . . = 현재 디렉토리 전체를 /app으로 복사
# --chown: 복사된 파일의 소유자를 appuser로 설정
COPY --chown=appuser:appuser . .

# entrypoint.sh를 실행 가능하게 설정
RUN chmod +x /app/entrypoint.sh

# -----------------------------------------------------------------------------
# 사용자 전환
# -----------------------------------------------------------------------------
# 이후 명령어는 appuser 권한으로 실행
USER appuser

# -----------------------------------------------------------------------------
# 포트 노출
# -----------------------------------------------------------------------------
# EXPOSE: 컨테이너가 사용할 포트 문서화 (실제 개방은 docker run -p로)
# FastAPI/Uvicorn 기본 포트: 8000
EXPOSE 8000

# -----------------------------------------------------------------------------
# 헬스체크 설정
# -----------------------------------------------------------------------------
# Docker가 컨테이너 상태를 주기적으로 확인
# --interval: 체크 간격 (30초)
# --timeout: 응답 대기 시간 (30초)
# --start-period: 시작 후 대기 시간 (40초, 마이그레이션 + 앱 초기화 시간)
# --retries: 실패 허용 횟수 (3회 실패 시 unhealthy)
# curl -f: HTTP 에러 코드 시 실패 반환
HEALTHCHECK --interval=30s --timeout=30s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# -----------------------------------------------------------------------------
# 애플리케이션 실행
# -----------------------------------------------------------------------------
# ENTRYPOINT: 컨테이너 시작 시 항상 실행되는 스크립트
# entrypoint.sh 실행 순서:
#   1. PostgreSQL 연결 대기 (pg_isready)
#   2. py_monitor 스키마 생성 (CREATE SCHEMA IF NOT EXISTS)
#   3. Alembic 마이그레이션 실행 (alembic upgrade head)
#   4. Uvicorn으로 FastAPI 앱 시작
#
# 프로덕션에서는 entrypoint.sh 내 uvicorn을 gunicorn으로 교체 권장:
# exec gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
ENTRYPOINT ["/app/entrypoint.sh"]
