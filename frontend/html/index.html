<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëŒ€ì‹œë³´ë“œ | PyMonitor</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/frontend/style/style.css">
</head>
<body>
  <!-- í—¤ë” -->
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">PyMonitor</a>
      <nav class="nav">
        <a href="index.html" class="nav-link active">ëŒ€ì‹œë³´ë“œ</a>
        <a href="project.html" class="nav-link">í”„ë¡œì íŠ¸ ë“±ë¡</a>
        <a href="tools.html" class="nav-link">ë„êµ¬</a>
      </nav>
      <div class="user-actions">
        <span class="user-name" id="user-name"></span>
        <button class="btn btn-secondary btn-sm" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </header>

  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <main class="main-content">
    <div class="container">
      <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
      <div class="page-header">
        <h1 class="page-title">ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>
        <a href="project.html" class="btn btn-primary">
          <span>+</span> í”„ë¡œì íŠ¸ ë“±ë¡
        </a>
      </div>

      <!-- í†µê³„ ì¹´ë“œ -->
      <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
          <div class="stat-label">ì „ì²´ í”„ë¡œì íŠ¸</div>
          <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ì •ìƒ ìš´ì˜</div>
          <div class="stat-value stat-success" id="stat-online">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ì˜¤ë¥˜ ë°œìƒ</div>
          <div class="stat-value stat-error" id="stat-offline">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">í‰ê·  ì‘ë‹µì‹œê°„</div>
          <div class="stat-value" id="stat-response">-</div>
        </div>
      </div>

      <!-- í”„ë¡œì íŠ¸ ê·¸ë¦¬ë“œ -->
      <div class="section-header">
        <h2 class="section-title">ë‚´ í”„ë¡œì íŠ¸</h2>
      </div>

      <div class="projects-grid" id="projects-grid">
        <!-- ë¡œë”© ìƒíƒœ -->
        <div class="loading" id="loading">
          <div class="loading-spinner"></div>
          <p>í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      </div>

      <!-- ë¹ˆ ìƒíƒœ (í”„ë¡œì íŠ¸ ì—†ì„ ë•Œ) -->
      <div class="empty-state" id="empty-state" style="display: none;">
        <div class="empty-icon">ğŸ“Š</div>
        <h3 class="empty-title">ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
        <p class="empty-description">ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ë“±ë¡í•˜ê³  ì›¹ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
        <a href="project.html" class="btn btn-primary">í”„ë¡œì íŠ¸ ë“±ë¡í•˜ê¸°</a>
      </div>
    </div>
  </main>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div class="modal" id="setting-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ëª¨ë‹ˆí„°ë§ ì„¤ì •</h3>
        <button type="button" class="modal-close" id="close-setting-modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="setting-form">
          <div class="form-group">
            <label class="form-label" for="check-interval">ì²´í¬ ì£¼ê¸° (ì´ˆ)</label>
            <input type="number" class="form-input" id="check-interval" min="10" value="300" required>
            <span class="form-hint">ìµœì†Œ 10ì´ˆ ì´ìƒ</span>
          </div>
          <div class="form-group">
            <label class="form-label" for="timeout">íƒ€ì„ì•„ì›ƒ (ì´ˆ)</label>
            <input type="number" class="form-input" id="timeout" min="1" value="30" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="retry-count">ì¬ì‹œë„ íšŸìˆ˜</label>
            <input type="number" class="form-input" id="retry-count" min="0" value="3" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="alert-threshold">ì•Œë¦¼ ì„ê³„ê°’</label>
            <input type="number" class="form-input" id="alert-threshold" min="1" value="3" required>
            <span class="form-hint">ì—°ì† ì‹¤íŒ¨ íšŸìˆ˜</span>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancel-setting">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary">ì €ì¥</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
  <div class="modal" id="detail-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 class="modal-title" id="detail-title">í”„ë¡œì íŠ¸ ìƒì„¸</h3>
        <button type="button" class="modal-close" id="close-detail-modal">&times;</button>
      </div>

      <!-- ëª¨ë‹¬ íƒ­ -->
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="detail-info">ì •ë³´</button>
        <button class="modal-tab" data-tab="detail-history">íˆìŠ¤í† ë¦¬</button>
        <button class="modal-tab" data-tab="detail-settings">ì„¤ì •</button>
      </div>

      <div class="modal-body">
        <!-- ì •ë³´ íƒ­ -->
        <div class="modal-tab-content active" id="tab-detail-info">
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div class="detail-section">
          <h4 class="detail-section-title">ê¸°ë³¸ ì •ë³´</h4>
          <div class="detail-row">
            <span class="detail-label">URL</span>
            <span class="detail-value" id="detail-url">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ìƒíƒœ</span>
            <span class="detail-value" id="detail-status">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì‘ë‹µ ì‹œê°„</span>
            <span class="detail-value" id="detail-response-time">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ë§ˆì§€ë§‰ ì²´í¬</span>
            <span class="detail-value" id="detail-last-check">-</span>
          </div>
        </div>

        <!-- SSL ì •ë³´ -->
        <div class="detail-section">
          <h4 class="detail-section-title">SSL ì¸ì¦ì„œ</h4>
          <div class="detail-row">
            <span class="detail-label">SSL ìƒíƒœ</span>
            <span class="detail-value" id="detail-ssl-status">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ë§Œë£Œì¼</span>
            <span class="detail-value" id="detail-ssl-expiry">-</span>
          </div>
        </div>

        <!-- ë„ë©”ì¸ ì •ë³´ -->
        <div class="detail-section">
          <h4 class="detail-section-title">ë„ë©”ì¸</h4>
          <div class="detail-row">
            <span class="detail-label">ë„ë©”ì¸ ë§Œë£Œì¼</span>
            <span class="detail-value" id="detail-domain-expiry">-</span>
          </div>
        </div>
        </div><!-- end tab-detail-info -->

        <!-- íˆìŠ¤í† ë¦¬ íƒ­ -->
        <div class="modal-tab-content" id="tab-detail-history">
          <div class="detail-section">
            <h4 class="detail-section-title">ëª¨ë‹ˆí„°ë§ íˆìŠ¤í† ë¦¬</h4>
            <div class="history-list" id="history-list">
              <div class="loading">
                <div class="loading-spinner"></div>
                <p>ë¡œë”© ì¤‘...</p>
              </div>
            </div>
          </div>
        </div><!-- end tab-detail-history -->

        <!-- ì„¤ì • íƒ­ -->
        <div class="modal-tab-content" id="tab-detail-settings">
        <!-- ëª¨ë‹ˆí„°ë§ ì„¤ì • -->
        <div class="detail-section">
          <h4 class="detail-section-title">ëª¨ë‹ˆí„°ë§ ì„¤ì •</h4>
          <form id="detail-setting-form">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="detail-check-interval">ì²´í¬ ì£¼ê¸° (ì´ˆ)</label>
                <input type="number" class="form-input" id="detail-check-interval" min="10" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="detail-timeout">íƒ€ì„ì•„ì›ƒ (ì´ˆ)</label>
                <input type="number" class="form-input" id="detail-timeout" min="1" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="detail-retry-count">ì¬ì‹œë„ íšŸìˆ˜</label>
                <input type="number" class="form-input" id="detail-retry-count" min="0" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="detail-alert-threshold">ì•Œë¦¼ ì„ê³„ê°’</label>
                <input type="number" class="form-input" id="detail-alert-threshold" min="1" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="detail-response-limit">ì‘ë‹µ ì†ë„ ì œí•œ (ì´ˆ)</label>
                <input type="number" class="form-input" id="detail-response-limit" min="1" value="5">
              </div>
              <div class="form-group">
                <label class="form-label" for="detail-expiry-dday">ë§Œë£Œì¼ ì•Œë¦¼ (D-day)</label>
                <input type="number" class="form-input" id="detail-expiry-dday" min="1" value="30">
              </div>
            </div>

            <!-- ì•Œë¦¼ ì„¤ì • -->
            <div class="form-section-divider"></div>
            <h5 class="form-subsection-title">ì•Œë¦¼ ì„¤ì •</h5>

            <div class="form-group">
              <label class="form-label form-checkbox">
                <input type="checkbox" id="detail-alert-enabled" checked>
                <span>ì•Œë¦¼ í™œì„±í™”</span>
              </label>
            </div>

            <div class="form-group">
              <label class="form-label" for="detail-alert-email">ì•Œë¦¼ ì´ë©”ì¼</label>
              <input type="email" class="form-input" id="detail-alert-email" placeholder="alert@example.com">
              <span class="form-hint">ì¥ì•  ë°œìƒ ì‹œ ì•Œë¦¼ì„ ë°›ì„ ì´ë©”ì¼</span>
            </div>

            <div class="form-group">
              <label class="form-label" for="detail-webhook-url">ì›¹í›… URL</label>
              <input type="url" class="form-input" id="detail-webhook-url" placeholder="https://hooks.slack.com/...">
              <span class="form-hint">Slack, Discord ë“± ì›¹í›… URL</span>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-danger" id="delete-project-btn">í”„ë¡œì íŠ¸ ì‚­ì œ</button>
              <button type="submit" class="btn btn-primary">ì„¤ì • ì €ì¥</button>
            </div>
          </form>
        </div>
        </div><!-- end tab-detail-settings -->
      </div>
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
  <div class="toast-container" id="toast-container"></div>

  <!-- JavaScript -->
  <script src="/frontend/js/auth.js"></script>
  <script src="/frontend/js/project.js"></script>
  <script src="/frontend/js/monitoring.js"></script>
  <script>
    // ì „ì—­ ìƒíƒœ
    let currentProjectId = null;
    let projects = [];

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      if (!auth.checkAuth()) return;

      // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
      displayUserInfo();

      // í”„ë¡œì íŠ¸ ëª©ë¡ ë¡œë“œ
      loadProjects();

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      setupEventListeners();
    });

    // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
    function displayUserInfo() {
      const user = auth.getUser();
      if (user) {
        document.getElementById('user-name').textContent = user.full_name || user.email;
      }
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupEventListeners() {
      // ë¡œê·¸ì•„ì›ƒ
      document.getElementById('logout-btn').addEventListener('click', () => {
        auth.logout();
      });

      // ì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
      document.getElementById('close-setting-modal').addEventListener('click', closeSettingModal);
      document.getElementById('cancel-setting').addEventListener('click', closeSettingModal);

      // ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
      document.getElementById('close-detail-modal').addEventListener('click', closeDetailModal);

      // ì„¤ì • í¼ ì œì¶œ
      document.getElementById('setting-form').addEventListener('submit', handleSettingSubmit);

      // ìƒì„¸ ì„¤ì • í¼ ì œì¶œ
      document.getElementById('detail-setting-form').addEventListener('submit', handleDetailSettingSubmit);

      // í”„ë¡œì íŠ¸ ì‚­ì œ
      document.getElementById('delete-project-btn').addEventListener('click', handleDeleteProject);

      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('active');
          }
        });
      });

      // ìƒì„¸ ëª¨ë‹¬ íƒ­ ì „í™˜
      document.querySelectorAll('.modal-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;

          // íƒ­ ë²„íŠ¼ í™œì„±í™”
          document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          // íƒ­ ì»¨í…ì¸  í™œì„±í™”
          document.querySelectorAll('.modal-tab-content').forEach(c => c.classList.remove('active'));
          document.getElementById(`tab-${tabId}`).classList.add('active');

          // íˆìŠ¤í† ë¦¬ íƒ­ ì„ íƒ ì‹œ ë¡œë“œ
          if (tabId === 'detail-history' && currentProjectId) {
            loadMonitoringHistory(currentProjectId);
          }
        });
      });
    }

    // í”„ë¡œì íŠ¸ ëª©ë¡ ë¡œë“œ
    async function loadProjects() {
      const grid = document.getElementById('projects-grid');
      const loading = document.getElementById('loading');
      const emptyState = document.getElementById('empty-state');

      try {
        projects = await project.getProjects();

        // ë¡œë”© ìˆ¨ê¹€
        loading.style.display = 'none';

        if (projects.length === 0) {
          grid.style.display = 'none';
          emptyState.style.display = 'flex';
          updateStats(0, 0, 0, '-');
          return;
        }

        emptyState.style.display = 'none';
        grid.style.display = 'grid';

        // í”„ë¡œì íŠ¸ ì¹´ë“œ ë Œë”ë§ (ì´ˆê¸°)
        renderProjects(projects);

        // ëª¨ë‹ˆí„°ë§ ìƒíƒœ ë¡œë“œ í›„ ì—…ë°ì´íŠ¸
        await loadMonitoringStatus();

        // í†µê³„ ì—…ë°ì´íŠ¸ (ëª¨ë‹ˆí„°ë§ ë°ì´í„° í¬í•¨)
        updateStatsFromProjects(projects);

        // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ ì‹œì‘
        captureAllScreenshots();

      } catch (error) {
        console.error('í”„ë¡œì íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
        loading.innerHTML = '<p class="text-error">í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        showToast('í”„ë¡œì íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ëª¨ë‹ˆí„°ë§ ìƒíƒœ ë¡œë“œ
    async function loadMonitoringStatus() {
      try {
        const statuses = await monitoring.getAllProjectsStatus();

        // ê° í”„ë¡œì íŠ¸ì— ëª¨ë‹ˆí„°ë§ ìƒíƒœ ë°ì´í„° ì¶”ê°€
        statuses.forEach(status => {
          const proj = projects.find(p => p.id === status.project_id);
          if (proj) {
            proj.monitoringStatus = status;
            proj.is_available = status.status?.is_available ?? null;
            proj.response_time = status.status?.response_time;
            proj.status_code = status.status?.status_code;
            proj.error_message = status.status?.error_message;
            proj.ssl_info = status.ssl;
            proj.last_checked_at = status.checked_at;
          }
        });

        // ëª¨ë‹ˆí„°ë§ ë°ì´í„°ë¡œ ì¹´ë“œ ë‹¤ì‹œ ë Œë”ë§
        renderProjects(projects);

      } catch (error) {
        console.error('ëª¨ë‹ˆí„°ë§ ìƒíƒœ ë¡œë“œ ì˜¤ë¥˜:', error);
        // ëª¨ë‹ˆí„°ë§ ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨í•´ë„ í”„ë¡œì íŠ¸ ëª©ë¡ì€ í‘œì‹œ
      }
    }

    // í”„ë¡œì íŠ¸ ì¹´ë“œ ë Œë”ë§
    function renderProjects(projects) {
      const grid = document.getElementById('projects-grid');
      grid.innerHTML = projects.map(p => createProjectCard(p)).join('');
    }

    // í”„ë¡œì íŠ¸ ì¹´ë“œ ìƒì„±
    function createProjectCard(proj) {
      // ëª¨ë‹ˆí„°ë§ ìƒíƒœ ê²°ì • (is_availableì´ nullì´ë©´ ëŒ€ê¸°ì¤‘)
      let statusClass, statusText;
      if (proj.is_available === null || proj.is_available === undefined) {
        statusClass = 'status-pending';
        statusText = 'ëŒ€ê¸°ì¤‘';
      } else if (proj.is_available === true) {
        statusClass = 'status-online';
        statusText = 'ì •ìƒ';
      } else {
        statusClass = 'status-offline';
        statusText = 'ì˜¤ë¥˜';
      }

      const responseTime = proj.response_time ? `${Math.round(proj.response_time * 1000)}ms` : '-';
      const statusCode = proj.status_code ? `HTTP ${proj.status_code}` : '';

      // SSL ìƒíƒœ
      let sslBadge = '';
      if (proj.ssl_info) {
        if (proj.ssl_info.is_valid) {
          const daysRemaining = proj.ssl_info.days_remaining;
          if (daysRemaining !== null && daysRemaining <= 30) {
            sslBadge = `<span class="ssl-badge ssl-warning" title="SSL ë§Œë£Œ ${daysRemaining}ì¼ ì „">SSL ${daysRemaining}ì¼</span>`;
          } else {
            sslBadge = '<span class="ssl-badge ssl-valid" title="SSL ìœ íš¨">SSL</span>';
          }
        } else {
          sslBadge = '<span class="ssl-badge ssl-invalid" title="SSL ì˜¤ë¥˜">SSL ì˜¤ë¥˜</span>';
        }
      }

      // ì¸ë„¤ì¼ URL ìƒì„± (ìºì‹œëœ ì´ë¯¸ì§€ ìš°ì„ )
      const thumbnailUrl = getThumbnailUrl(proj.url, proj.snapshot_path);

      return `
        <div class="project-card" data-id="${proj.id}">
          <div class="project-thumbnail" onclick="openDetailModal(${proj.id})">
            <img src="${thumbnailUrl}" alt="${escapeHtml(proj.title)}" loading="lazy" onerror="this.src='/frontend/img/placeholder.svg'; this.onerror=null;">
            <div class="thumbnail-overlay">
              <div class="status-group">
                <span class="project-status ${statusClass}">${statusText}</span>
                ${sslBadge}
              </div>
            </div>
          </div>
          <div class="project-card-body" onclick="openDetailModal(${proj.id})">
            <h3 class="project-title">${escapeHtml(proj.title)}</h3>
            <p class="project-url">${escapeHtml(proj.url)}</p>
            ${proj.error_message ? `<p class="project-error">${escapeHtml(proj.error_message)}</p>` : ''}
          </div>
          <div class="project-card-footer">
            <div class="project-stat">
              <span class="project-stat-label">ì‘ë‹µì‹œê°„</span>
              <span class="project-stat-value">${responseTime}</span>
            </div>
            <div class="project-stat">
              <span class="project-stat-label">ìƒíƒœì½”ë“œ</span>
              <span class="project-stat-value">${statusCode || '-'}</span>
            </div>
            <div class="project-stat">
              <span class="project-stat-label">ë§ˆì§€ë§‰ ì²´í¬</span>
              <span class="project-stat-value">${formatTime(proj.last_checked_at)}</span>
            </div>
          </div>
          <button class="project-menu-btn" onclick="event.stopPropagation(); openSettingModal(${proj.id})">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="1"></circle>
              <circle cx="12" cy="5" r="1"></circle>
              <circle cx="12" cy="19" r="1"></circle>
            </svg>
          </button>
        </div>
      `;
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats(total, online, offline, avgResponse) {
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-online').textContent = online;
      document.getElementById('stat-offline').textContent = offline;
      document.getElementById('stat-response').textContent = avgResponse;
    }

    // í”„ë¡œì íŠ¸ ë°ì´í„°ë¡œ í†µê³„ ì—…ë°ì´íŠ¸
    function updateStatsFromProjects(projects) {
      const total = projects.length;

      // ëª¨ë‹ˆí„°ë§ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ìƒíƒœ ê³„ì‚°
      const online = projects.filter(p => p.is_available === true).length;
      const offline = projects.filter(p => p.is_available === false).length;
      const pending = total - online - offline;

      // ì‘ë‹µì‹œê°„ ê³„ì‚° (ì´ˆ ë‹¨ìœ„ë¥¼ msë¡œ ë³€í™˜)
      const responseTimes = projects
        .filter(p => p.response_time !== null && p.response_time !== undefined)
        .map(p => p.response_time * 1000); // ì´ˆ -> ms

      const avgResponse = responseTimes.length > 0
        ? Math.round(responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length) + 'ms'
        : '-';

      updateStats(total, online, offline, avgResponse);
    }

    // ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
    function openSettingModal(projectId) {
      currentProjectId = projectId;
      document.getElementById('setting-modal').classList.add('active');
    }

    // ì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
    function closeSettingModal() {
      document.getElementById('setting-modal').classList.remove('active');
      currentProjectId = null;
    }

    // ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
    async function openDetailModal(projectId) {
      currentProjectId = projectId;
      const modal = document.getElementById('detail-modal');

      try {
        const proj = projects.find(p => p.id === projectId);
        if (!proj) return;

        // ê¸°ë³¸ ì •ë³´ ì„¤ì •
        document.getElementById('detail-title').textContent = proj.title;
        document.getElementById('detail-url').textContent = proj.url;

        // ëª¨ë‹ˆí„°ë§ ìƒíƒœ í‘œì‹œ
        let statusHtml;
        if (proj.is_available === null || proj.is_available === undefined) {
          statusHtml = '<span class="badge badge-pending">ëŒ€ê¸°ì¤‘</span>';
        } else if (proj.is_available === true) {
          statusHtml = '<span class="badge badge-success">ì •ìƒ</span>';
        } else {
          statusHtml = '<span class="badge badge-error">ì˜¤ë¥˜</span>';
        }
        if (proj.status_code) {
          statusHtml += ` <span class="badge badge-info">HTTP ${proj.status_code}</span>`;
        }
        document.getElementById('detail-status').innerHTML = statusHtml;

        // ì‘ë‹µì‹œê°„ (ì´ˆ -> ms ë³€í™˜)
        const responseTimeMs = proj.response_time ? `${Math.round(proj.response_time * 1000)}ms` : '-';
        document.getElementById('detail-response-time').textContent = responseTimeMs;
        document.getElementById('detail-last-check').textContent = formatDateTime(proj.last_checked_at);

        // SSL ì •ë³´ (ëª¨ë‹ˆí„°ë§ ë°ì´í„°ì—ì„œ)
        if (proj.ssl_info) {
          const ssl = proj.ssl_info;
          if (ssl.is_valid) {
            document.getElementById('detail-ssl-status').innerHTML = '<span class="badge badge-success">ìœ íš¨</span>';
            if (ssl.valid_until) {
              document.getElementById('detail-ssl-expiry').textContent =
                `${formatDate(ssl.valid_until)} (${ssl.days_remaining}ì¼ ë‚¨ìŒ)`;
            }
          } else {
            document.getElementById('detail-ssl-status').innerHTML = '<span class="badge badge-error">ì˜¤ë¥˜</span>';
            document.getElementById('detail-ssl-expiry').textContent = '-';
          }
        } else {
          document.getElementById('detail-ssl-status').textContent = '-';
          document.getElementById('detail-ssl-expiry').textContent = '-';
        }

        // ë„ë©”ì¸ ì •ë³´
        document.getElementById('detail-domain-expiry').textContent = proj.domain_expiry_date ? formatDate(proj.domain_expiry_date) : '-';

        // ëª¨ë‹ˆí„°ë§ ì„¤ì • ë¡œë“œ
        try {
          const settings = await monitoring.getSettings(projectId);
          document.getElementById('detail-check-interval').value = settings.check_interval || 300;
          document.getElementById('detail-timeout').value = settings.timeout || 30;
          document.getElementById('detail-retry-count').value = settings.retry_count || 3;
          document.getElementById('detail-alert-threshold').value = settings.alert_threshold || 3;
          document.getElementById('detail-response-limit').value = settings.response_time_limit || 5;
          document.getElementById('detail-expiry-dday').value = settings.expiry_alert_days || 30;
          // ì•Œë¦¼ ì„¤ì •
          document.getElementById('detail-alert-enabled').checked = settings.is_alert_enabled !== false;
          document.getElementById('detail-alert-email').value = settings.alert_email || '';
          document.getElementById('detail-webhook-url').value = settings.webhook_url || '';
        } catch (settingsError) {
          console.warn('ëª¨ë‹ˆí„°ë§ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', settingsError);
          // ê¸°ë³¸ê°’ ì„¤ì •
          document.getElementById('detail-check-interval').value = 300;
          document.getElementById('detail-timeout').value = 30;
          document.getElementById('detail-retry-count').value = 3;
          document.getElementById('detail-alert-threshold').value = 3;
          document.getElementById('detail-response-limit').value = 5;
          document.getElementById('detail-expiry-dday').value = 30;
          document.getElementById('detail-alert-enabled').checked = true;
          document.getElementById('detail-alert-email').value = '';
          document.getElementById('detail-webhook-url').value = '';
        }

        modal.classList.add('active');

      } catch (error) {
        console.error('ìƒì„¸ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
        showToast('ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
    function closeDetailModal() {
      document.getElementById('detail-modal').classList.remove('active');
      currentProjectId = null;
    }

    // ì„¤ì • í¼ ì œì¶œ
    async function handleSettingSubmit(e) {
      e.preventDefault();

      const settings = {
        check_interval: parseInt(document.getElementById('check-interval').value),
        timeout: parseInt(document.getElementById('timeout').value),
        retry_count: parseInt(document.getElementById('retry-count').value),
        alert_threshold: parseInt(document.getElementById('alert-threshold').value)
      };

      try {
        await monitoring.updateSettings(currentProjectId, settings);
        showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        closeSettingModal();
        loadProjects();
      } catch (error) {
        console.error('ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
        showToast('ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ìƒì„¸ ì„¤ì • í¼ ì œì¶œ
    async function handleDetailSettingSubmit(e) {
      e.preventDefault();

      const alertEmail = document.getElementById('detail-alert-email').value.trim();
      const webhookUrl = document.getElementById('detail-webhook-url').value.trim();

      const settings = {
        check_interval: parseInt(document.getElementById('detail-check-interval').value),
        timeout: parseInt(document.getElementById('detail-timeout').value),
        retry_count: parseInt(document.getElementById('detail-retry-count').value),
        alert_threshold: parseInt(document.getElementById('detail-alert-threshold').value),
        response_time_limit: parseInt(document.getElementById('detail-response-limit').value),
        expiry_alert_days: parseInt(document.getElementById('detail-expiry-dday').value),
        is_alert_enabled: document.getElementById('detail-alert-enabled').checked,
        alert_email: alertEmail || null,
        webhook_url: webhookUrl || null
      };

      try {
        await monitoring.updateSettings(currentProjectId, settings);
        showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        closeDetailModal();
        loadProjects();
      } catch (error) {
        console.error('ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
        showToast('ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // í”„ë¡œì íŠ¸ ì‚­ì œ
    async function handleDeleteProject() {
      if (!confirm('ì •ë§ ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await project.deleteProject(currentProjectId);
        showToast('í”„ë¡œì íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        closeDetailModal();
        loadProjects();
      } catch (error) {
        console.error('í”„ë¡œì íŠ¸ ì‚­ì œ ì˜¤ë¥˜:', error);
        showToast('í”„ë¡œì íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ëª¨ë‹ˆí„°ë§ íˆìŠ¤í† ë¦¬ ë¡œë“œ
    async function loadMonitoringHistory(projectId) {
      const historyList = document.getElementById('history-list');
      historyList.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>ë¡œë”© ì¤‘...</p>
        </div>
      `;

      try {
        const logs = await monitoring.getLogs(projectId, 0, 50);

        if (logs.length === 0) {
          historyList.innerHTML = '<p class="empty-message">ëª¨ë‹ˆí„°ë§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        historyList.innerHTML = logs.map(log => `
          <div class="history-item ${log.is_available ? 'history-success' : 'history-error'}">
            <div class="history-status">
              <span class="history-icon">${log.is_available ? 'âœ“' : 'âœ—'}</span>
              <span class="history-time">${formatDateTime(log.created_at)}</span>
            </div>
            <div class="history-details">
              ${log.status_code ? `<span class="history-code">HTTP ${log.status_code}</span>` : ''}
              ${log.response_time ? `<span class="history-response">${Math.round(log.response_time * 1000)}ms</span>` : ''}
              ${log.error_message ? `<span class="history-error-msg">${escapeHtml(log.error_message)}</span>` : ''}
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
        historyList.innerHTML = '<p class="error-message">íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;

      container.appendChild(toast);

      // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ ë”œë ˆì´
      setTimeout(() => toast.classList.add('show'), 10);

      // 3ì´ˆ í›„ ì œê±°
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ì¸ë„¤ì¼ URL ìƒì„± (ìºì‹œëœ ë¡œì»¬ ì´ë¯¸ì§€ ìš°ì„ )
    function getThumbnailUrl(url, cachedPath) {
      // ìºì‹œëœ ìŠ¤í¬ë¦°ìƒ·ì´ ìˆìœ¼ë©´ ì‚¬ìš©
      if (cachedPath) {
        return cachedPath;
      }
      // ìºì‹œ ì—†ìœ¼ë©´ placeholder ë°˜í™˜
      return '/frontend/img/placeholder.svg';
    }

    // í”„ë¡œì íŠ¸ ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ ìš”ì²­ (ë°±ê·¸ë¼ìš´ë“œ)
    async function captureScreenshot(projectId) {
      try {
        const response = await fetch(`/api/v1/projects/${projectId}/screenshot?force=false`, {
          headers: auth.getAuthHeaders()
        });
        if (response.ok) {
          const data = await response.json();
          return data.screenshot_url;
        }
      } catch (error) {
        console.error('ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ ì˜¤ë¥˜:', error);
      }
      return null;
    }

    // ëª¨ë“  í”„ë¡œì íŠ¸ ìŠ¤í¬ë¦°ìƒ· ë°±ê·¸ë¼ìš´ë“œ ìº¡ì²˜
    async function captureAllScreenshots() {
      for (const proj of projects) {
        if (!proj.snapshot_path) {
          const screenshotUrl = await captureScreenshot(proj.id);
          if (screenshotUrl) {
            proj.snapshot_path = screenshotUrl;
            // í•´ë‹¹ ì¹´ë“œë§Œ ì—…ë°ì´íŠ¸
            const card = document.querySelector(`.project-card[data-id="${proj.id}"]`);
            if (card) {
              const img = card.querySelector('.project-thumbnail img');
              if (img) {
                img.src = screenshotUrl;
              }
            }
          }
        }
      }
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatTime(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'ë°©ê¸ˆ ì „';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}ë¶„ ì „`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}ì‹œê°„ ì „`;
      return `${Math.floor(diff / 86400000)}ì¼ ì „`;
    }

    function formatDateTime(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleString('ko-KR');
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('ko-KR');
    }
  </script>
</body>
</html>
